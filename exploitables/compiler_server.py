import socket
import subprocess
import threading
import time
import os

PORT = 33333

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(("0.0.0.0", PORT))
s.listen(1000)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

def serve(conn, i):
	
	yesed = False
	viewed = False
	try:
		conn.sendall("Please input your file.\n")
		fileContents = ""
		data = conn.recv(4096)
		while data != "":
			fileContents += data
			data = conn.recv(4096)
		#conn.sendall("Writing your file to disk.\n")
		with open(str(i) + ".c", 'w') as myfile:
			myfile.write(fileContents)
		#conn.sendall("Compiling your file.\n")
		os.system("gcc " + str(i) + ".c -o" + str(i))
		#time.sleep(1)
		#conn.sendall("Running your file.\n")
		os.system("./" + str(i))

	except Exception as e:
		print e
print "Awaiting connections"
i = 0
while True:
	conn, addr = s.accept()
	t = threading.Thread(target = serve, args=(conn, i))
	i += 1
	t.start()

